#!/usr/bin/env bash
set -e

# Check if running in iTerm
if [ "$TERM_PROGRAM" != "iTerm.app" ]; then
  echo "[error] This command only works in iTerm.app"
  exit 1
fi

# Get current working directory
WORKDIR="$PWD"

script_dir="$(cd "$(dirname "$0")" && pwd)"
OPENCODE_CONFIG="$WORKDIR/.opencode/opencode.json"
CODEX_HOME="$WORKDIR/.codex"
repo_url="https://github.com/ebijun1007/vibe-in-iterm.git"
template_dir="$script_dir/templates"
cleanup_dir=""

if [ ! -d "$template_dir" ]; then
  if command -v git >/dev/null 2>&1; then
    cleanup_dir="$(mktemp -d)"
    git clone -q --depth 1 "$repo_url" "$cleanup_dir/repo"
    template_dir="$cleanup_dir/repo/templates"
  else
    echo "[warn] git not found and templates directory missing; skipping template copy"
    template_dir=""
  fi
fi

# Copy templates into the current directory without overwriting existing files
if [ -n "$template_dir" ] && [ -d "$template_dir" ]; then
  mapfile -t cloned < <(rsync -ai --ignore-existing "$template_dir"/ "$WORKDIR"/ | cut -c12-)
  if [ ${#cloned[@]} -gt 0 ]; then
    echo "[info] Cloned templates into $WORKDIR: ${cloned[*]}"
  else
    echo "[info] Templates already present; nothing to clone"
  fi
else
  echo "[warn] Template directory not found; skipping template copy"
fi

[ -n "$cleanup_dir" ] && rm -rf "$cleanup_dir"

# Run AppleScript to create iTerm layout
osascript <<EOF
on run
  set workdir to "$WORKDIR"
  set envExports to "export OPENCODE_CONFIG=\"$OPENCODE_CONFIG\"; export CODEX_HOME=\"$CODEX_HOME\";"

  tell application "iTerm"
    -- keep current window, just add a new tab
    set theWindow to current window
    tell theWindow
      create tab with default profile
      set theTab to current tab
    end tell

    -- first session in the new tab
    tell current session of theTab
      -- split into left and right
      set leftPane to it
      set rightPane to (split vertically with default profile)
    end tell

    -- split the right pane into 3 sections (top, middle, bottom)
    tell rightPane
      set topRight to it
      set middleBottomPane to (split horizontally with default profile)
    end tell

    tell middleBottomPane
      set middleRight to it
      set bottomRight to (split horizontally with default profile)
    end tell

    -- left pane: just cd into the repo
    tell leftPane
      write text "cd " & workdir & "; " & envExports
    end tell

    -- top-right: run codex
    tell topRight
      write text "cd " & workdir & "; " & envExports & " codex"
    end tell

    -- bottom-right: run claude with --dangerously-skip-permissions
    tell middleRight
      write text "cd " & workdir & "; " & envExports & " claude --dangerously-skip-permissions"
    end tell

  end tell
end run
EOF

echo "[done] iTerm layout created for: $WORKDIR"
