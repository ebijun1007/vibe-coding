#!/usr/bin/env bash
set -e

# Get current working directory
WORKDIR="$PWD"

script_dir="$(cd "$(dirname "$0")" && pwd)"
repo_url="https://github.com/ebijun1007/vibe-in-iterm.git"
template_dir="$script_dir/templates"
cleanup_dir=""
todo_path="$WORKDIR/todo.md"
data_dir="$HOME/Library/Application Support/ai/bloop/vibe-kanban"

mkdir -p "$data_dir"
if [ -f "$WORKDIR/profiles.json" ]; then
  cp "$WORKDIR/profiles.json" "$data_dir/profiles.json"
  echo "[info] Copied profiles.json to $data_dir"
else
  echo "[warn] profiles.json not found in repo root; skipping copy"
fi

if [ ! -d "$template_dir" ]; then
  if command -v git >/dev/null 2>&1; then
    cleanup_dir="$(mktemp -d)"
    git clone -q --depth 1 "$repo_url" "$cleanup_dir/repo"
    template_dir="$cleanup_dir/repo/templates"
  else
    echo "[warn] git not found and templates directory missing; skipping template copy"
    template_dir=""
  fi
fi

# Copy templates into the current directory without overwriting existing files
if [ -n "$template_dir" ] && [ -d "$template_dir" ]; then
  mapfile -t cloned < <(rsync -ai --ignore-existing "$template_dir"/ "$WORKDIR"/ | cut -c12-)
  if [ ${#cloned[@]} -gt 0 ]; then
    echo "[info] Cloned templates into $WORKDIR: ${cloned[*]}"
  else
    echo "[info] Templates already present; nothing to clone"
  fi
else
  echo "[warn] Template directory not found; skipping template copy"
fi

[ -n "$cleanup_dir" ] && rm -rf "$cleanup_dir"

# Ensure .gitignore has expected entries
ignore_entries=(.claude .opencode .codex .design refactor.json issues.md todo.md)
gitignore_path="$WORKDIR/.gitignore"
[[ -f "$gitignore_path" ]] || touch "$gitignore_path"
added_entries=()
for entry in "${ignore_entries[@]}"; do
  if ! grep -qxF "$entry" "$gitignore_path"; then
    echo "$entry" >> "$gitignore_path"
    added_entries+=("$entry")
  fi
done
if [ ${#added_entries[@]} -gt 0 ]; then
  echo "[info] Updated .gitignore with: ${added_entries[*]}"
fi

# Seed opencode.json if missing
opencode_path="$WORKDIR/opencode.json"
if [ ! -f "$opencode_path" ]; then
  cat > "$opencode_path" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "agent": {
    "build": {
      "description": "Default coding mode with only OpenCode tools.",
      "tools": {
        "read": true,
        "write": true,
        "edit": true,
        "bash": true,
        "grep": true,
        "glob": true,
        "list": true,
        "webfetch": true,
        "patch": true,
        "todoread": true,
        "todowrite": true
      },
      "prompt": "{file:./.claude/CLAUDE.md}"
    }
  },
  "instructions": [
    ".claude/CLAUDE.md",
    ".design/architecture.md",
    ".design/guidelines.md",
    ".design/decisions.md"
  ]
}
EOF
  echo "[info] Wrote opencode.json to $opencode_path"
else
  echo "[info] opencode.json already exists; leaving as-is"
fi

# Open todo.md in VS Code for the current directory
if command -v code >/dev/null 2>&1; then
  [ -f "$todo_path" ] || touch "$todo_path"
  code "$todo_path"
else
  echo "[warn] code command not found; skipping opening todo.md"
fi

echo "[done] Workspace prepared for: $WORKDIR"

# Launch vibe-kanban in the foreground at the end (vibe-kanban will pick an available port)
if command -v npx >/dev/null 2>&1; then
  echo "[info] Starting vibe-kanban in foreground (Ctrl+C to stop; logs below)"
  (cd "$WORKDIR" && PORT=3000 npx vibe-kanban)
else
  echo "[warn] npx not found; cannot start vibe-kanban"
fi
